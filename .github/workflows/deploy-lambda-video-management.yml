name: Deploy Lambda Video Management

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build --configuration Release --no-restore

    - name: Run tests
      run: dotnet test --configuration Release --no-build --verbosity normal

    - name: Publish application
      run: |
        dotnet publish src/VideoProcessing.VideoManagement.Api/VideoProcessing.VideoManagement.Api.csproj \
          --configuration Release \
          --output ./publish \
          --runtime linux-x64 \
          --self-contained false

    - name: Create deployment package
      run: |
        cd publish
        zip -r ../deployment-package.zip .

    - name: Configure AWS credentials
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

    - name: Deploy to Lambda
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      run: |
        FUNCTION_NAME=${{ vars.LAMBDA_FUNCTION_NAME || 'video-processing-engine-dev-video-management' }}
        aws lambda update-function-code \
          --function-name $FUNCTION_NAME \
          --zip-file fileb://deployment-package.zip

    - name: Wait for Lambda update
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      run: |
        FUNCTION_NAME=${{ vars.LAMBDA_FUNCTION_NAME || 'video-processing-engine-dev-video-management' }}
        aws lambda wait function-updated --function-name $FUNCTION_NAME

    - name: Update Lambda configuration
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      run: |
        FUNCTION_NAME=${{ vars.LAMBDA_FUNCTION_NAME || 'video-processing-engine-dev-video-management' }}
        REGION=${{ vars.AWS_REGION || 'us-east-1' }}
        GATEWAY_PREFIX=${{ vars.GATEWAY_PATH_PREFIX || '' }}
        
        # Update Handler
        aws lambda update-function-configuration \
          --function-name $FUNCTION_NAME \
          --handler VideoProcessing.VideoManagement.Api
          
        # Update Environment Variables
        # We merge existing vars with new ones
        EXISTING_VARS=$(aws lambda get-function-configuration --function-name $FUNCTION_NAME --query 'Environment.Variables' --output json)
        
        # Define base variables from GitHub Variables if available
        # Note: In a real scenario, we would use a script to merge JSONs properly.
        # Here we perform a simplified update.
        
        aws lambda update-function-configuration \
          --function-name $FUNCTION_NAME \
          --environment "Variables={
            AWS__Region=$REGION,
            DynamoDB__Region=$REGION,
            DynamoDB__TableName=${{ vars.DYNAMODB_TABLE_NAME }},
            S3__Region=$REGION,
            S3__BucketVideo=${{ vars.S3_BUCKET_VIDEO }},
            S3__BucketFrames=${{ vars.S3_BUCKET_FRAMES }},
            S3__BucketZip=${{ vars.S3_BUCKET_ZIP }},
            Cognito__Region=$REGION,
            Cognito__UserPoolId=${{ vars.COGNITO_USER_POOL_ID }},
            Cognito__ClientId=${{ vars.COGNITO_CLIENT_ID }},
            GATEWAY_PATH_PREFIX=$GATEWAY_PREFIX,
            ASPNETCORE_ENVIRONMENT=Production
          }"

    - name: Verify deployment
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      run: |
        FUNCTION_NAME=${{ vars.LAMBDA_FUNCTION_NAME || 'video-processing-engine-dev-video-management' }}
        aws lambda get-function --function-name $FUNCTION_NAME --query 'Configuration.[FunctionName,LastModified,State,Handler]' --output table

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: deployment-package.zip
